name: Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # - name: Install git-crypt
      # run: sudo apt-get install -y git-crypt

      # - name: Setup git-crypt key
      # env:
      # GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      # run: echo "$GIT_CRYPT_KEY" | base64 -d > ./git-crypt-key

      # - name: Unlock repo secrets
      # run: git-crypt unlock ./git-crypt-key

      # - name: Remove key
      # run: rm ./git-crypt-key

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: "9.6.7"
          cabal-version: "3.10"

      - name: Cache
        uses: actions/cache@v3
        env:
          cache-name: cache-cabal
        with:
          path: ~/.cabal
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/*.cabal') }}-${{ hashFiles('**/cabal.project') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: Install dependencies
        run: |
          cabal update
          cabal build --only-dependencies --enable-tests --enable-benchmarks

      - name: Build
        run: cabal build --enable-tests --enable-benchmarks all

      - name: Run tests
        run: cabal test all
